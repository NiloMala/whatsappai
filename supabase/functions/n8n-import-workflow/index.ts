import { serve } from "https://deno.land/std@0.168.0/http/server.ts";

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

serve(async (req) => {
  // Handle CORS preflight requests
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders });
  }

  try {
    const requestBody = await req.json();
    const { workflow, workflowName, n8nUrl, n8nApiKey, workflowId, instanceName } = requestBody;

    console.log('üîß Importando workflow:', workflowName);
    console.log('üì¶ Workflow nodes:', workflow?.nodes?.length || 0);
    console.log('üîó Workflow connections:', Object.keys(workflow?.connections || {}).length);
    console.log('üîë N8N URL:', n8nUrl);
    console.log('üîê N8N API Key presente:', !!n8nApiKey);
    console.log('üÜî Workflow ID para update:', workflowId || 'novo workflow');
    console.log('üì± Instance Name:', instanceName);

    if (!workflow || !workflow.nodes) {
      console.error('‚ùå Workflow inv√°lido - nodes ausentes');
      throw new Error('Workflow inv√°lido: nodes n√£o encontrados');
    }

    if (!n8nApiKey) {
      console.error('‚ùå N8N API Key ausente');
      throw new Error('N8N API Key n√£o fornecida');
    }

    if (!n8nUrl) {
      console.error('‚ùå N8N URL ausente');
      throw new Error('N8N URL n√£o fornecida');
    }

    // Atualizar instanceName nos n√≥s Evolution API
    if (instanceName && workflow.nodes) {
      let updatedCount = 0;
      workflow.nodes.forEach((node: any) => {
        if (node.type === 'n8n-nodes-evolution-api.evolutionApi' && node.parameters) {
          node.parameters.instanceName = instanceName;
          updatedCount++;
        }
      });
      console.log('üìù N√≥s Evolution API atualizados:', updatedCount);
    }

    // Remover campos read-only que o n8n n√£o aceita na cria√ß√£o
    const cleanWorkflow = {
      name: workflowName,
      nodes: workflow.nodes || [],
      connections: workflow.connections || {},
      settings: {
        executionOrder: workflow.settings?.executionOrder || 'v1',
      },
      staticData: workflow.staticData || null,
    };

    let workflowResult;
    let isUpdate = false;

    // Se tiver workflowId, atualizar; sen√£o, criar novo
    if (workflowId) {
      isUpdate = true;
      const updateWorkflowResponse = await fetch(`${n8nUrl}/api/v1/workflows/${workflowId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-N8N-API-KEY': n8nApiKey,
        },
        body: JSON.stringify(cleanWorkflow),
      });

      if (!updateWorkflowResponse.ok) {
        const errorText = await updateWorkflowResponse.text();
        throw new Error(`Atualizar workflow falhou: ${updateWorkflowResponse.status} - ${errorText}`);
      }

      workflowResult = await updateWorkflowResponse.json();
    } else {
      console.log('üì§ Enviando workflow para n8n...');
      console.log('üîó URL:', `${n8nUrl}/api/v1/workflows`);
      console.log('üìã Workflow name:', cleanWorkflow.name);
      console.log('üìä Nodes count:', cleanWorkflow.nodes.length);

      const createWorkflowResponse = await fetch(`${n8nUrl}/api/v1/workflows`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-N8N-API-KEY': n8nApiKey,
        },
        body: JSON.stringify(cleanWorkflow),
      });

      console.log('üì• Resposta do n8n:', createWorkflowResponse.status, createWorkflowResponse.statusText);

      if (!createWorkflowResponse.ok) {
        const errorText = await createWorkflowResponse.text();
        console.error('‚ùå Erro ao criar workflow no n8n:');
        console.error('  Status:', createWorkflowResponse.status);
        console.error('  Response:', errorText);

        // Tentar parsear como JSON para obter mais detalhes
        try {
          const errorJson = JSON.parse(errorText);
          console.error('  Error details:', JSON.stringify(errorJson, null, 2));
        } catch (e) {
          // N√£o √© JSON, j√° logamos o texto
        }

        throw new Error(`Criar workflow falhou: ${createWorkflowResponse.status} - ${errorText}`);
      }

      workflowResult = await createWorkflowResponse.json();
      console.log('‚úÖ Workflow criado com sucesso:', workflowResult.id);
    }

    const createdWorkflow = workflowResult;

    // Ativar o workflow
    const activateResponse = await fetch(`${n8nUrl}/api/v1/workflows/${createdWorkflow.id}/activate`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-N8N-API-KEY': n8nApiKey,
      },
    });

    if (!activateResponse.ok) {
      const errorText = await activateResponse.text();
      console.warn('Aviso ao ativar workflow:', errorText);
    }

    // Retornar informa√ß√µes do workflow criado/atualizado
    return new Response(
      JSON.stringify({
        success: true,
        workflowId: createdWorkflow.id,
        workflowUrl: `${n8nUrl}/workflow/${createdWorkflow.id}`,
        message: isUpdate ? 'Workflow atualizado e ativado com sucesso' : 'Workflow importado e ativado com sucesso',
      }),
      {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 200,
      }
    );

  } catch (error) {
    console.error('‚ùå Erro ao importar workflow:', error);
    console.error('Stack trace:', (error as any)?.stack);

    return new Response(
      JSON.stringify({
        success: false,
        error: (error as any)?.message || String(error) || 'Erro desconhecido',
        details: (error as any)?.stack || '',
      }),
      {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 500,
      }
    );
  }
});
