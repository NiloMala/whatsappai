import { serve } from "https://deno.land/std@0.168.0/http/server.ts";

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

serve(async (req) => {
  // Handle CORS preflight requests
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders });
  }

  try {
    const { workflow, workflowName, n8nUrl, n8nApiKey, workflowId } = await req.json();

    console.log('üîß Importando/Atualizando workflow no n8n:', workflowName);
    console.log('üÜî Workflow ID existente:', workflowId || 'Novo workflow');

    // Remover campos read-only que o n8n n√£o aceita na cria√ß√£o
    const cleanWorkflow = {
      name: workflowName,
      nodes: workflow.nodes || [],
      connections: workflow.connections || {},
      settings: workflow.settings || {
        executionOrder: 'v1',
      },
      staticData: workflow.staticData || null,
      // N√ÉO incluir: active, id, versionId, meta, tags, createdAt, updatedAt
    };

    console.log('üì¶ Workflow limpo:', JSON.stringify(cleanWorkflow, null, 2));

    let workflowResult;
    let isUpdate = false;

    // Se tiver workflowId, atualizar; sen√£o, criar novo
    if (workflowId) {
      console.log('üîÑ Atualizando workflow existente:', workflowId);
      isUpdate = true;
      
      const updateWorkflowResponse = await fetch(`${n8nUrl}/api/v1/workflows/${workflowId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-N8N-API-KEY': n8nApiKey,
        },
        body: JSON.stringify(cleanWorkflow),
      });

      if (!updateWorkflowResponse.ok) {
        const errorText = await updateWorkflowResponse.text();
        console.error('‚ùå Erro ao atualizar workflow:', errorText);
        throw new Error(`Atualizar workflow falhou: ${updateWorkflowResponse.status} - ${errorText}`);
      }

      workflowResult = await updateWorkflowResponse.json();
      console.log('‚úÖ Workflow atualizado no n8n:', workflowResult.id);
    } else {
      console.log('‚ûï Criando novo workflow');
      
      const createWorkflowResponse = await fetch(`${n8nUrl}/api/v1/workflows`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-N8N-API-KEY': n8nApiKey,
        },
        body: JSON.stringify(cleanWorkflow),
      });

      if (!createWorkflowResponse.ok) {
        const errorText = await createWorkflowResponse.text();
        console.error('‚ùå Erro ao criar workflow:', errorText);
        throw new Error(`Criar workflow falhou: ${createWorkflowResponse.status} - ${errorText}`);
      }

      workflowResult = await createWorkflowResponse.json();
      console.log('‚úÖ Workflow criado no n8n:', workflowResult.id);
    }

    const createdWorkflow = workflowResult;

    // Ativar o workflow usando endpoint espec√≠fico
    console.log('üîÑ Ativando workflow:', createdWorkflow.id);
    
    // Tentar endpoint /activate
    const activateResponse = await fetch(`${n8nUrl}/api/v1/workflows/${createdWorkflow.id}/activate`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-N8N-API-KEY': n8nApiKey,
      },
    });

    console.log('üìä Status da ativa√ß√£o:', activateResponse.status);

    if (!activateResponse.ok) {
      const errorText = await activateResponse.text();
      console.error('‚ö†Ô∏è Aviso ao ativar workflow:', activateResponse.status, errorText);
      // N√£o falha se n√£o conseguir ativar, pois o workflow foi criado
    } else {
      const activateResult = await activateResponse.json();
      console.log('‚úÖ Workflow ativado com sucesso:', activateResult);
    }

    // Retornar informa√ß√µes do workflow criado/atualizado
    return new Response(
      JSON.stringify({
        success: true,
        workflowId: createdWorkflow.id,
        workflowUrl: `${n8nUrl}/workflow/${createdWorkflow.id}`,
        message: isUpdate ? 'Workflow atualizado e ativado com sucesso' : 'Workflow importado e ativado com sucesso',
      }),
      {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 200,
      }
    );

  } catch (error) {
    console.error('‚ùå Erro ao importar workflow:', error);
    
    return new Response(
      JSON.stringify({
        success: false,
        error: error.message,
      }),
      {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 500,
      }
    );
  }
});
